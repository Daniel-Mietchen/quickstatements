<template id='main-page-template'>
	<div>
        <div>
            <p tt='intro'></p>
            <ul>
                <li>
                    <router-link class='btn btn-outline-primary' to='/batch'>New batch</router-link>
                </li>
                <li>
                    <form class='form-inline'>
                        <input class='form-control' type='text' id='batch_id' placeholder='batch number' style='width:10em' v-model='batch_id' />
                        <input class='btn btn-outline-primary' type='submit' value='See batch details' @click.prevent='showBatch' />
                    </form>
                </li>
                <li>
                    <form class='form-inline'>
                        <input class='form-control' type='text' id='user_name' placeholder='user name' style='width:10em' v-model='username' />
                        <input class='btn btn-outline-primary' type='submit' value='See batches by user' @click.prevent='showBatchesByUser' />
                    </form>
                </li>
            </ul>
        </div>
	</div>
</template>

<script>
'use strict';

let MainPage = Vue.extend ( {
        props : ['q','url_params'] ,
        data : function () { return { batch_id:'',username:'' } } ,
        created : function () {
            if ( typeof this.url_params != 'undefined' ) {
                let m ;
                if ( this.url_params == 'mode=batches' ) {
                    this.$router.push ( '/batches/' ) ;
                } else if ( (m=this.url_params.match(/^mode=batches&user=(.+)$/))!==null ) {
                    this.$router.push ( '/batches/'+encodeURIComponent(m[1]) ) ;
                } else if ( (m=this.url_params.match(/^v1=(.+)$/))!==null ) {
                    this.createTemporaryBatchV1 ( m[1] ) ;
                } else {
                    console.log ( this.url_params ) ;
                }
            }
        } ,
        updated : function () { tt.updateInterface(this.$el) ; } ,
        mounted : function () { tt.updateInterface(this.$el) ; } ,
        methods : {
            createTemporaryBatchV1 : function ( qs ) {
                var me = this ;
                console.log ( qs ) ;
                $.post ( './api.php' , {
                    action:'import',
                    temporary:1,
                    data:qs,
                    compress:1,
                    format:'v1',
                } , function ( d ) {
                    console.log ( d ) ;
                    if ( d.status != 'OK' ) {
                        alert ( "Error when trying to parse V1 URL data: "+d.status ) ;
                        return ;
                    }
                    me.$router.push ( '/batch/?tempfile='+encodeURIComponent(d.data) );
                } , 'json' ) ;
            } ,
            showBatchesByUser : function () {
                var me = this ;
                if ( $.trim(me.username) == '' ) {
                    $('#user_name').addClass('is-invalid') ;
                    return ;
                }
                this.$router.push ( '/batches/'+encodeURIComponent(me.username.replace(/_/g,' ')) ) ;
            } ,
            showBatch : function () {
                var me = this ;
                let id = me.batch_id * 1 ;
                if ( id == 0 ) {
                    $('#batch_id').addClass('is-invalid') ;
                    return ;
                }
                this.$router.push ( '/batch/'+id ) ;
            }
        },
        template:'#main-page-template'
    } ) ;
</script>
